\documentclass{article}

% Bibliography
\usepackage{natbib}
\bibpunct{(}{)}{;}{a}{}{;}

% Use 'It was found that A is B (Name 1234)' style
\setcitestyle{authoryear,open={},close={}}

% Affiliations
\usepackage{authblk}
\title{The error when inferring phylogenies with incipient species by a Birth-Death model}
% \subtitle{Should protracted speciation be incorporated in phylogenetic tree construction methods?}

\author[1]{Rich\`el J.C. Bilderbeek}
\author[1]{Rampal S. Etienne}
\affil[1]{Groningen Institute for Evolutionary Life Sciences, University of Groningen, Groningen, The Netherlands}

% Load my functions
\input{functions.tex}

% Use double spacing
\usepackage{setspace}
\doublespacing

\usepackage{listings}
\usepackage{hyperref}
\usepackage{todonotes}
\usepackage{verbatim}
\usepackage{pgf}
\usepackage{bm}

% TikZ and friends
\usepackage{tikz}
\usepackage{tkz-graph}
\usepackage{pgf}
\usetikzlibrary{arrows,automata}

% Style of listings
% From http://r.789695.n4.nabble.com/How-to-nicely-display-R-code-with-the-LaTeX-package-listings-tp4648110.html
\usepackage{fancyvrb} 
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolor}{rgb}{0.95,0.95,0.92}
\lstdefinestyle{mystyle}{
  language=R,% set programming language
  basicstyle=\ttfamily\small,% basic font style
  commentstyle=\color{gray},% comment style
  % numbers=left,% display line numbers on the left side
  numberstyle=\scriptsize,% use small line numbers
  numbersep=10pt,% space between line numbers and code
  tabsize=2,% sizes of tabs
  showstringspaces=false,% do not replace spaces in strings by a certain character
  captionpos=b,% positioning of the caption below
  breaklines=true,% automatic line breaking
  escapeinside={(*}{*)},% escaping to LaTeX
  fancyvrb=true,% verbatim code is typset by listings
  extendedchars=false,% prohibit extended chars (chars of codes 128--255)
  alsoletter={.<-},% becomes a letter
  alsoother={$},% becomes other
  otherkeywords={!=, ~, $, \&, \%/\%, \%*\%, \%\%, <-, <<-, /},% other keywords
  deletekeywords={c}% remove keywords 
}
\lstset{style=mystyle}

% Adds numbered lines
\usepackage{lineno}
\linenumbers

% Use TODO notes
\usepackage{todonotes}


% Rename 'Abstract' to 'Summary 
\usepackage[english]{babel}
\addto{\captionsenglish}{\renewcommand{\abstractname}{Summary}}

\begin{document}

\maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Phylogenetics enables us to infer which species lived when and
estimate how long it took for a species to give rise to a new
lineage. Phylogenies show us taxa that have completed speciation, yet
those taxa only: species that are in the process of speciation are 
overlooked.

There are multiple reasons why a speciation event, during
or after its course, goes unnoticed. It may be that the build-up
of reproductive isolation is still in an intermediate stage. But it
may also be that speciation has completed, but we, humans, have not
yet observed it. One example are the four African giraffe species, 
that have been thought to have been one single species up until 2016,
where the MRCA of the two most recent species goes back 1.6 million years.

It took some time until the Birth-Death model, a phylogenetic model
assuming constant rates of speciation and extinction, got extended
by a version that incorporates the fact that speciation takes time.
This extension is called the Protracted Birth-Death model. In this
model, a branching event does not give rise to a new species, but to
a new species-to-be, called an incipient species. Such an incipient
species may go extinct, or finish its speciation to become a good species.

Although we know speciation takes time, most of our theoretical 
phylogenetic modeling ignores this fact. To the best of our knowledge,
there is no tool incorporating this fact. One reason may be to ease
computation, enabling researchers to work on bigger phylogenies (with
more power statistical power) instead. Additionally, speciation being
protracted is only playing a role in the present. As seen from the present,
all older species have finished speciation, as we -by definition- recognize
these species as such. 

There are problems with ignoring protracted speciation. A very pragmatic
example is the conservation of the now four smaller groups of giraffes,
instead of one big group. But from a more theoretical perspective, the
observed decline of speciation rate in time (excluding the contemporary human-driven
mass extinction event) may be explained by these new species not being 
recognized yet. Another problem is that the MRCA of young species is estimated 
incorrectly, as in the BD model a species can be ultra-young (as speciation
is assumed to be instantaneous), where the PBD model will place these MRCAs
further back in time (as two events need to have finished completion).

From a theoretical point of view, there is another reason why protracted
speciation has yet become a member of our toolbox: there is no framework
where it fits in: a framework assumes either an analysis at the species or
subspecies level. When picking a tool that does its analysis at the
species level, there is no protocol how to select which incipient species
gets to represent the full species it is still a member of. When picking
a tool at the sub-species level, the incipient state disappears as a
sub-species lineage, and the process degrades to an ordinary birth-death 
process.

This exploratory research's goal is to produce a 
usefull and balanced data set, that quantifies the inference error 
we make from choosing an overly simplistic prior. In this context, 
we measure the error made on phylogenies in which speciation takes 
time, when using a Birth-Death prior.

The parameter space the data set explores is inspired on 
[Etienne et al, 2014] for two reasons: (1) the academic
reason of being able to compare results, and (2) the practical
reason that the simulated phylogies will have enough taxa to
be informative, but not too big to be computationally overdemanding.
This research uses a complete superset of those parameter settings.
For the speciation initiation rate, we'll use $0.1$, $0.5$ and $1.0$ 
speciation initiation events per (good species) lineage per time unit, 
extending the set of
values used from one ($0.5$) to three. 
The speciation completion
rates used are $0.1$, $0.3$, $1.0$ and $10^6$ speciation completion
events per (incipient species) lineage per time unit, in which only
the last value is added as a computational proxy for infinity, which
makes the experiment fall back to a Birth-Death model (as speciation
is again instantaneous), allowing to measure the baseline error.
The extinction rates used are $0.0$, $0.1$, $0.2$ and $0.4$ 
extinction events per (good or incipient) lineage per time unit,
in which $0.4$ is a new extinction rate.
We investigate these parameters in a factorial fashion, except for
(1) those combinations in which the extinction rate equals or exceeds
the speciation initiation rate, and (2) the difference between
speciation initiation rate and extinction rate exceeds 0.8. This is
done to prevent overly taxon-poor and taxon-rich phylogenies respectively.

From each biological parameter set, a protracted birth-death tree is simulated,
with the same crown age as [Etienne et al., 2014] of 15 million years. 
Each protracted birth-death tree uses a different random number
generatior seed, and thus will be unique, resulting in a balanced 
data set. 

From an incipient species tree, we sample a species tree
by picking either the youngest or oldest
species-to-be to represent the full species.
We use either sampling method in 50\% of all cases. We chose not to use
a random species-to-be to represent a full species as to maximize variance
in this aspect. Note that only in few cases (when speciation completion rate
is low) the sampling method has an effect on the branch length distribution
of the sampled species tree, as this requires a very specific scenario.

From a species tree, we simulate a DNA alignment that has the same history
as the phylogeny. The nucleotides of the DNA alignment follow a JC69
nucleotide substitution model, in which all nucleotide-to-nucleotide transitions
are equally likely. Although this may seem as a simplification, in our Bayesian
inference (see below) we can use this exact site model as a prior, which we 
know is the truth.
The DNA sequence length and mutation rate was chosen as such to provide one
nucleotide change per 1000 years per lineage. As our time unit is in 
millions of years, this equates to a rate of 1000 nucleotide substitutions 
changes per time unit per lineage. To provide for each substitution being unique,
we simulate as much DNA nucleotides as expected mutations, which equals the
nucleotide substitution rate times the crown age, which equals 15K. As this
mutation rate is constant over all branches, it in effect follows a strict 
clock model, which we will specify as the known clock model prior later.

From an alignment, we run a Bayesian analysis and create a posterior, 
using the phylogetic tool BEAST2. We assume a
JC69 nucleotide substitution (as we do use that), a strict clock model (as
we have that) and a Birth-Death tree prior (as this simplification is the goal
of this research). Additionally, we assume a MRCA prior with a normal distribution
with a mean of the crown age, and a standard deviation of 0.001 time units. 0.001
time units equates to 1000 years, which is the same resolution as which the
alignment is created. After discarding a burn-in of 10\%, the MCMC algorithm must 
result in an ESS of the posterior of at least 200 and the MCMC chain length is 
chosen as such that this is the case for all simulations. For simulations
with an ESS below 200, their MCMC chain length is elongated. An
MCMC chain is elongated by the proportion that is expected to increase it to 220. 
For example, would an ESS be 165, increasing its MCMC chain length by 33\% 
would bring it to (165\%*1.33=) 220. We use 220 as a safeguard to prevent 
an asymptotic approach to 200. 

We realize there will be an unavoidable bias in our data set: the MCMC
algorithm will produce phylogenies that are representative for the joint
likelihood of (correct) site model, (correct) clock model and 
(incorrect) (Birth-Death) speciation model. This will
warp the distribution of phylogenies somewhat towards the incorrect
speciation model: branch length distributions that are likely in the
Birth-Death model will be relatively overrepresented. We expect
this bias to be systematic, equally affecting distributions
of identical speciation completion rates, and symptomatic
of using contemporary tools.

Each posterior's phylogeny is compared to the 'true' species tree.
To quantify the difference between two phylogenies, the nLTT statistic
is used. The nLTT statistic equates to the area between the normalized
lineages-through-time-plots of two phylogenies, which will be a value between 
zero (for identical phylogenies) and one. As the nLTT statistic increases
when phylogenies get increasingly different, we use the nLTT statistic
as a measure of inference error. Comparing the one 'true' species tree
with each of the posterior's species trees, a distribution nLTT statistics
is created. 

We predict that nLTT statistic values increase 
with an increasing protractednedness (that is, a low speciation completion rate),
but we cannot predict the the extent of this error, as it has never been 
measured [NOTE: this may be easy to change: Etienne \& Rosindel 2012 show the equations
for the expected number of lineages through time. I think I may be able to pull
of a prediction here, by fitting a BD curve on a PBD curve with a minimized error,
but research would be needed to investigate that].

The data set produced by this exploratory research will consist out of two files:
one containing raw data, the other summarized data. 
A data file should be convenient to handle, thus as an upper limit for this data set's size, 
we use the maximum size of a table (called a data frame) of the R programming 
language. Within R, such a table may have maximally $2^{32}-1$ cells and occupy
less then 2 gigabytes in memory. 
The raw data file will contain parameters and 1000 nLTT statistics values.
Each row will contain the parameter set and these nLTT statistics.
From the constraints of the R programming language, this allows for 40K rows. 
The file with the summarized data will provide summary statistics of the raw
data. Each row will contain a parameter set, summary statistics and other
measurements. See the appendix, chapter 'Data set specifications', for the full list.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Glossary}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Please supply, as a separate list, the definitions of field-specific terms used in your article.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Acknowledgements}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We would like to thank the Center for Information Technology of the University of Groningen for their support
and for providing access to the Peregrine high performance computing cluster.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Authors' contributions}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Bibliography
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MEE style
\bibliographystyle{mee}
\bibliography{article}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Abbreviations}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{table}
  \centering 
  \begin{tabular}{l l}
    \hline
    Symbol & Description \\
    \hline
    \hline
    $b_g$ & Speciation initiation rate of a good species (probability per lineage, per million year) \\
    $b_i$ & Speciation initiation rate of an incipient species (probability per lineage, per million year) \\
    $\lambda$ & Speciation completion rate (probability per lineage, per million year) \\
    $\mu_g$ & Extinction rate of a good species (probability per lineage, per million year) \\
    $\mu_i$ & Extinction rate of an incipient species (probability per lineage, per million year) \\
    \hline
    $t_c$ & Crown age (million years) \\
    $r$ & Mutation rate (probability of mutation per nucleotide per million years) \\
    $l_a$ & DNA alignment length (base pairs) \\
    \hline
    $n_i$ & Number of incipient species trees per parameter set \\
    $n_a$ & Number of alignments per species tree \\
    $n_b$ & Number of BEAST2 runs per alignment \\
    \hline
    $n_s$ & Number of MCMC samples \\
    $i_s$ & MCMC sampling interval \\
    \hline
    $n_{ti}$ & Number of taxa in an incipient species tree \\
    $n_{t}$ & Number of taxa in a (good) species tree \\
    $t_{\mean{ds}}$ & Average duration of speciation \\
    $t_{sc}$ & Speciation completion time \\
    $\Delta_{nLTT}$ & nLTT statistic value \\
    $\mean{\Delta_{nLTT}}$ & Average nLTT statistic value of a posterior \\
    $\median{\Delta_{nLTT}}$ & Median nLTT statistic value of a posterior \\
    \hline
  \end{tabular}
  \caption{
    Parameter descriptions. The sections are (1) the biological parameters, (2) the
    biological tuning parameters, (3) parameters involved in replication, (4) MCMC
    tuning parameters, and (5) other symbols.
  }
  \label{table:parameter_descriptions}
\end{table}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Parameters}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{table}
  \centering 
  \begin{tabular}{l l}
    \hline
    Parameter             & Values \\
    \hline
    \hline
    $b = b_g = b_i$       & 0.1, 0.5, 1.0 \\
    $\lambda$             & 0.1, 0.3, 1.0, $10^6$ \\
    $\mu = \mu_g = \mu_i$ & 0.0, 0.1, 0.2, 0.4 \\
    \hline
    $t_c$                 & 15 \\
    $r$                   & 1000 \\
    $l_a$                 & $15000$ \\
    \hline
    $n_i$                 & 178 \\
    $n_a$                 & 2 per species tree\\
    $n_b$                 & 2 per alignment\\
    \hline
    $n_s$                 & $10^3$ states (sampled)\\
    $i_s$                 & $10^3$ states (between samples)\\
    \hline
  \end{tabular}
  \caption{
    Parameter values. The sections are (1) the biological parameters, (2) the
    biological tuning parameters, (3) parameters involved in replication, 
    and (4) MCMC tuning parameters.
  }
  \label{table:parameter_values}
\end{table}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Data set specifications}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The raw data file will consist of 40K rows. On each row there will be 1012 values:

\begin{itemize}  
  \item 12 simulation parameters:
  \begin{enumerate}  
    \item speciation initiation rate
    \item speciation completion rate
    \item extinction rate
    \item crown age
    \item crown age sigma
    \item sampling method
    \item mutation rate
    \item sequence length
    \item mcmc length
    \item tree sim rng seed
    \item alignment rng seed
    \item beast2 rnd seed
  \end{enumerate}
  \item 1000 nLTT statistics
\end{itemize}

The summarized data file will consist of 40K rows. On each row there will be 29 values:

\begin{itemize}  
  \item 12 simulation parameters:
  \begin{enumerate}  
    \item speciation initiation rate
    \item speciation completion rate
    \item extinction rate
    \item crown age
    \item crown age sigma
    \item sampling method
    \item mutation rate
    \item sequence length
    \item mcmc length
    \item tree sim rng seed
    \item alignment rng seed
    \item beast2 rnd seed
  \end{enumerate}
  \item [NOTE: add yes/no?] expected speciation completion time (from Etienne \& Rosindell 2012)
  \item [NOTE: add yes/no?] expected duration of speciation (from Etienne \& Rosindell 2012)
  \item number of taxa in incipient species tree (also: number of subspecies)
  \item [NOTE: add yes/no?] would there be a difference in brach lengths between the two sampling methods?
  \item number of taxa in species tree (also: number of species)
  \item mean nLTT statistic
  \item median nLTT statistic
  \item lower bound of 95\% HPD value of nLTT statistic
  \item upper bound of 95\% HPD value of nLTT statistic
  \item 11 ESSes of all parameters estimated by BEAST2:
  \begin{enumerate}  
    \item posterior
    \item likelihood 
    \item prior 
    \item treeLikelihood 
    \item TreeHeight 
    \item BirthDeath 
    \item BDBirthRate 
    \item BDDeathRate 
    \item logP.mrca 
    \item mrcatime 
    \item clockRate
  \end{enumerate}
  \item [some] MCMC operator acceptances
\end{itemize}

\end{document}
